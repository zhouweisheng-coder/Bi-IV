# 第六章 近似最近邻查找与YouTube推荐系统

[TOC]



### Thinking1  什么是近似最近邻查找，常用的方法有哪些      能简要说明近似最近邻查找（5point）     常用的方法（5point）  

* 近似最近邻检索（ANN，Approximate Nearest Neighbor）利用数据量增大后数据之间会形成**簇状聚集分布**的特性，通过对数据分析**聚类**的方法对数据库中的数据进行分类或编码，对于目标数据根据其数据特征预测其所属的数据类别，返回类别中的部分或全部作为检索结果 。近似最近邻检索，在牺牲可接受范围内的精度的情况下提高检索效率，适合处理大规模数据

* 常用方法包括：

  * 局部敏感哈希（LSH）
    核心思想：在高维空间相邻的数据经过**哈希函数的映射**投影转化到低维空间后，他们落入同一个吊桶的概率很大而不相邻的数据映射到同一个吊桶的概率则很小。在检索时将欧式空间的距离计算转化到**汉明**（Hamming）空间，并将全局检索转化为对映射到同一个吊桶中的数据进行检索，从而提高了检索速度。这种方法的主要难点在于如何寻找适合的哈希函数。

    * minihash：用文档里所有词**最小的K个哈希值**做特征集合，表征这篇文档；文档之间的相似度在这个集合上用**Jaccard**距离；适合海量文档，所有文档只做一遍预处理，两两之间的词集合大大减小；

      ```
      1. 把文档A分词形成分词向量L
      2. 使用K个hash函数，然后每个hash将L里面的分词分别进行hash，然后得到K个被hash过的集合
      3. 分别得到K个集合中的最小hash，然后组成一个长度为K的hash集合
      4. 最后用Jaccard index求出两篇文档的相似度
      ```

    * simhash：海量文本去重（允许一定的噪声）；文档里权重**最大的前N个词**进行Hash编码，1正0负乘以词的权重，N个词的向量按位相加，再反编码（正1负0），得到该文档的编码；两篇文档的距离用编码的**汉明**距离，小于Bar则认为二者相似；

      ```
      1. 把文档A分词形成分词向量L，L中的每一个元素都包涵一个分词C以及一个分词的权重W
      2. 对L中的每一个元素的分词C进行hash，得到C1，然后组成一个新的向量L1
      3. 初始化一个长度大于C1长度的向量V，所有元素初始化为0
      4. 分别判断L1中的每一个元素C1的第i位，如果C1i是1，那么Vi加上w，否则Vi减去w
      5. 最后判断V中的每一项，如果第i项大于0，那么第i项变成1，否则变成0
      6. 两篇文档a,b分别得到aV,bV
      6. 最后求出aV和bV的汉明距离，一般距离不大于3的情况下说明两篇文档是相似的
      ```

  * 矢量量化
    其代表是乘积量化（PQ）。它的主要思想是将特征向量进行**正交分解**，在分解后的低维正交子空间上进行**量化**，由于低维空间可以采用较小的码本进行编码，因此可以降低数据存储空间 。PQ方法采用基于查找表的非对称距离计算(Asymmetric Distance Computation，ADC)快速求取特征向量之间的距离，在压缩比相同的情况下，与采用汉明距离的二值编码方法相比，采用ADC的PQ方法的**检索精度更高**。



### Thinking2  为什么两个集合的minhash值相同的概率等于这两个集合的Jaccard相似度    能简要说明MinHash值相同的概率与Jaccard相似度相等的证明（10point）                

* Ci和Cj代表两列的数值，h(Ci)为Ci列的哈希，P为概率。Ci和Cj对应的列有三种可能：

  A类：两列的值都为1；

  B类：其中一列的值为0，另一列的值为1；

  C类：两列的值都为0.

  因为C类对结果没有影响，可以删除。那么此时，

  **P(h(Ci)=h(Cj)) = P(删掉C类后第一行为A类的概率)  = A类行的个数/所有行的个数 = a/(a+b)**，而a/(a+b)正好为Jaccard相似度，所以，Ci，Cj的MinHash值相等的概率，对他们的Jaccard相似度进行估计。

  ![image-20201003201355235](C:\Users\Zhou\AppData\Roaming\Typora\typora-user-images\image-20201003201355235.png)

* ![image-20201003200855237](C:\Users\Zhou\AppData\Roaming\Typora\typora-user-images\image-20201003200855237.png)

### Thinking3  SimHash在计算文档相似度的作用是怎样的？      

#### 1、文档SimHash的计算过程（5points）   

* Step1，设置SimHash的**位数，比如32位**，需要综合考虑存储成本以及数据集的大小
* Step2，初始化SimHash，将**各位初始化为0** 
* Step3，提取文本中的特征，比如采用2-Shingles

"the cat sat on the mat"=>{"th", "he", "e ", " c", "ca", "at", "t ", " s", "sa", " o", "on", "n ", " t", " m", "ma"} 

* Step4，使用**传统的hash函数**计算各个word的hashcode

比如："th".hash = -502157718 ，"he".hash = -369049682，…… 

* Step5，对各word的hashcode的每一位，如果该位为1，则simhash相应位的值**加它的权重**（通常是出现的频率）；否则**减**它的权重 

Step6，计算最后得到的32位的SimHash，如果该位**大于0，则设为1**；否则设为0 

#### 2、如何通过文档的SimHash计算文档之间的相似度（5points）   

* 计算两个文档指纹的海明距离

* 通常2篇文档的Hamming距离在3以内，就认为相似度比较高 => 两篇文档基本相同

###  Thinking4  为什么YouTube采用期望观看时间作为评估指标      能简要说明原因（10points）    

* CTR指标对于视频搜索具有一定的**欺骗性**，因为CTR指标只有**0和1**两种标签，而观看时长并不只是二分类问题，所以论文提出采用期望观看时间作为评估指标
  * 划分样本空间时，正样本为有点击视频，负样本为无点击视频，作者采用一种加权逻辑回归基于交叉熵损失进行训练。加权方案为，正样本用观看时间赋予权值，负样本赋予单位权值。

---

---

---





Action1  使用MinHashLSHForest对微博新闻句子进行检索  weibo.txt     针对某句话进行Query，查找Top-3相似的句子      1、完成代码（30points）     2、使用MinHashLSHForest工具对MinHash进行index，并完成Query Top-K，代码正确（30points）  









---

| 分类           | 内容                                                         | 数据集 | 是否了解掌握                                                 | 评阅点                                                       | GitHub代码 |
| -------------- | ------------------------------------------------------------ | ------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ---------- |
| 课上理解部分   |                                                              |        |                                                              |                                                              |            |
| 原理           | 什么是近似最近邻查找，常用的方法有哪些                       |        |                                                              |                                                              |            |
| 原理           | 什么是Hash函数                                               |        |                                                              |                                                              |            |
| 原理           | 什么是k-shingle                                              |        |                                                              |                                                              |            |
| 原理           | 最小哈希值                                                   |        |                                                              |                                                              |            |
| 原理           | MinHash执行                                                  |        |                                                              |                                                              |            |
| 原理           | MinHashLSH                                                   |        |                                                              |                                                              |            |
| 原理           | MinHash与Jaccard相似度                                       |        |                                                              |                                                              |            |
| 工具           | DataSketch中的MinHash,  MinHashLSH, MinHashLSHForest, MinHashLSHEnsemble |        |                                                              |                                                              |            |
| 工具           | 如何使用MinHashLSHForest对新闻句子Top-K相似内容进行查找      |        |                                                              |                                                              |            |
| 原理           | 汉明（Hamming）距离                                          |        |                                                              |                                                              |            |
| 原理           | SimHash算法流程                                              |        |                                                              |                                                              |            |
| 原理           | 如何通过SimHash算法得到每篇文档指纹                          |        |                                                              |                                                              |            |
| 工具           | 如何通过SimHash工具计算两篇文档的Hamming距离                 |        |                                                              |                                                              |            |
| 原理           | YouTube召回阶段DNN（输入、隐藏层、输出）                     |        |                                                              |                                                              |            |
| 原理           | YouTube排序阶段DNN（输入、隐藏层、输出）                     |        |                                                              |                                                              |            |
| 原理           | 正负样本和上下文选择                                         |        |                                                              |                                                              |            |
| 原理           | 负采样 Negative Sampling                                     |        |                                                              |                                                              |            |
| 原理           | 为什么YouTube采用期望观看时间作为评估指标                    |        |                                                              |                                                              |            |
| 原理           | 为什么YouTube在排序阶段没有采用经典的LR（逻辑回归）当作输出层，而是采用了Weighted  Logistic Regression？ |        |                                                              |                                                              |            |
| 课下思考与练习 |                                                              |        |                                                              |                                                              |            |
| Thinking1      | 什么是近似最近邻查找，常用的方法有哪些                       |        |                                                              | 能简要说明近似最近邻查找（5point）     常用的方法（5point）  |            |
| Thinking2      | 为什么两个集合的minhash值相同的概率等于这两个集合的Jaccard相似度 |        | 能简要说明MinHash值相同的概率与Jaccard相似度相等的证明（10point） |                                                              |            |
| Thinking3      | SimHash在计算文档相似度的作用是怎样的？                      |        |                                                              | 1、文档SimHash的计算过程（5points）     2、如何通过文档的SimHash计算文档之间的相似度（5points） |            |
| Thinking4      | 为什么YouTube采用期望观看时间作为评估指标                    |        |                                                              | 能简要说明原因（10points）                                   |            |
| Action1        | 使用MinHashLSHForest对微博新闻句子进行检索  weibo.txt     针对某句话进行Query，查找Top-3相似的句子 |        |                                                              | 1、完成代码（30points）     2、使用MinHashLSHForest工具对MinHash进行index，并完成Query Top-K，代码正确（30points） |            |